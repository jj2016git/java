# mysql调优

## 索引

### 目的

- 加速检索

### 特点

- 分散存储
- 硬盘级数据结构（如B-tree, B+ tree）

### 例子

- id索引：建立映射关系<id，数据存储的磁盘地址>

### 意义

- 减少扫描的数据量
- 随机IO -> 顺序IO
- 分组、排序时避免使用临时表

### 数据结构B+树

> 数据结构可视化网站：https://www.cs.usfca.edu/~galles/visualization/Algorithms.html

- BST：退化成链表，查找时间最差O(n)

- 平衡二叉树

  - 平衡二叉树：每个节点的高度差不超过1

  - AVL树：整棵树高度差不超过1

  - 红黑树

  - 缺点：每个节点数据量小，树高度大，未充分利用磁盘IO数据交换特性（OS每次读4k）及预读取能力（空间局部性原理）

    > 预读取能力：OS读取磁盘目标页时，会同时读取相邻的页

- 多路平衡B树

  - 绝对平衡树
  - degree：子节点数量，N个子节点，N-1个key

- B+树

  - 与B-树差别，
    - 中间节点不存数据，因此degree > B-树
    - 叶子节点形成链表，有利于顺序扫描全表
    - 查询时间稳定

### mysql索引

#### Myisam

- 分别存放数据文件及索引文件
- B+树叶子节点存放数据的磁盘地址
- 每个索引都是结构相同的B+树

#### innodb

- 为主键建立主索引B+树，如果表没有主键，innodb会自动建立6Byte整数为主键
- 主索引树叶节点存放完整数据
- 辅助索引B+树叶子节点存放主键值，查询时，首先查询辅助索引树得到主键值，然后查询主索引树，得到数据

#### innodb优势

#### 其他概念

- 聚集索引：数据物理顺序与key的索引顺序相同
- 覆盖索引：查询列可以直接通过索引节点的关键字返回
  - e.g. 建立[name, phoneNum]联合索引
    - select name, phoneNum from ... where name ='aa';
- 联合索引：[key1, key2]
  - 如何选择联合索引
    - 常用列优先
    - 离散度高的列优先
    - 宽度小的列优先

#### 索引生效->最左匹配原则 + 离散度

- 离散度：index engine对数据进行采样分析数据是否> 离散度阈值，小于阈值，则索引不生效
  - 离散度 = count(distinct(key)) / count(key)
- 最左匹配原则：
  - 原因：**字符型key通过最左匹配进行比较**
  - 实践：
    - not in, <>， like '%...'无法使用索引
    - 联合索引[key1, key2], key1为范围查询，key2无法使用索引
    - 范围查询，order by可以用索引
    - like 'foo%'能否用索引看数据离散度

 
