# 分布式事务解决方案

## 分布式事务场景

下单

- 锁定库存
- 创建订单

### 分布式事务解决方案

事务管理器（TM）：协调者

资源管理器（RM）

应用程序（AP）

XA事务指令：RM与TM接口规范

TCC事务（应用层）：应用实现try, confirm, cancel接口，由业务代码实现分布式事务

github tcc-transaction, ByteTCC

#### DTP: 2pc

- 阶段一：事务询问
  - TM向所有ap发送事务
  - ap调RM执行事务，写入事务日志
  - ap ack
- 阶段二：事务提交（失败概率极低）
  1. 成功
     1. 发送commit请求
     2. 反馈执行结果
  2. 失败
     1. 发送rollback请求
     2. 。。。

#### 3pc

- stage1: cancommit
- stage2: precommit
- stage3: do commit
- 引入超时，解决2pc prepare阶段可能的阻塞

CAP, BASE

弱一致性

消息队列

1. 消息重复处理（幂等问题）
   1. 数据库唯一约束（报错）
   2. token机制
   3. 状态机
      1. 通过状态实现幂等
      2. 。。。驱动数据变化



# 限流和降级

- 增加吞吐量：缓存、集群、异步化、服务化
- 保障服务可用性：缓存、限流、降级

## 缓存

- 热点数据
- 速度：内存 > 缓存 > DB

## 降级

- 人工降级
  - 
- 自动降级

## 限流

- 针对恶意流量的限流（安全部门）
- 针对资源：限流策略、熔断策略

### 限流算法

#### 滑动窗口

通过窗口大小限制并发度，降低临界风险

Semphore, countdownLatch: 将请求放入队列

#### 漏桶算法

