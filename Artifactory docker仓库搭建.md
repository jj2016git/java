# Artifactory docker仓库搭建

## Artifactory virtual repository搭建

虚拟仓库可以包含多个本地仓库及多个远程仓库，

其中：

开发人员可以把内部依赖的镜像推送到本地仓库，每个虚拟仓库有一个默认接收镜像的本地仓库。

开发人员可以通过远程仓库拉取外网镜像。

## docker client直连仓库配置

### 仓库配置

`> admin > http settings`

- docker access method: repository path
- reverse proxy settings: embedded tomcat

### docker client配置

`/etc/docker/daemon.json`

```
{
    "insecure-registries" : [ "192.168.58.1:8081" ],
    "registry-mirrors" : ["http://192.168.58.1:8081"]
}
```

### docker client命令

- 登录：`docker login -u admin -p password 192.168.58.1:8081`
- 拉镜像：
  - 官方镜像：`docker pull 192.168.58.1:8081/v-docker/library/tomcat`
  - 非官方镜像：`docker pull 192.168.58.1:8081/v-docker/jelastic/tomcat`
- 推镜像：`docker push 192.168.58.1:8081/v-docker/hello-world-local`

## docker client通过反向代理连接仓库配置：sub domain

### Artifactory配置

`> admin > http settings`

- docker access method: sub domain
- reverse proxy settings: nginx 80

### nginx配置

```
###########################################################
## this configuration was generated by JFrog Artifactory ##
###########################################################

## server configuration
server {
    
    listen 80 ;
    server_name ~(?<repo>.+)\.myartifactory myartifactory;
    
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/myartifactory-access.log timing;
    ## error_log /var/log/nginx/myartifactory-error.log;
    rewrite ^/$ /artifactory/webapp/ redirect;
    rewrite ^/artifactory/?(/webapp)?$ /artifactory/webapp/ redirect;
    rewrite ^/(v1|v2)/(.*) /artifactory/api/docker/$repo/$1/$2;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location /artifactory/ {
    proxy_read_timeout  2400s;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    if ( $request_uri ~ ^/artifactory/(.*)$ ) {
        proxy_pass          http://localhost:8081/artifactory/$1;
    }
    proxy_pass          http://localhost:8081/artifactory/;
    proxy_set_header    X-Artifactory-Override-Base-Url $http_x_forwarded_proto://$host:$server_port/artifactory;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    }
}
```

### docker client配置

```json
{
    "insecure-registries" : [ "192.168.58.1:8081" ],
    "registry-mirrors" : ["http://192.168.58.1:8081"]
}
```

### docker client命令

```
docker login v-docker.myartifactory
docker pull v-docker.myartifactory/library/hello-world
docker push v-docker.myartifactory/nginx
```

## docker client通过反向代理连接仓库配置：port bindings

### Artifactory配置

`> admin > http settings`

- docker access method: Port
- reverse proxy settings: nginx 80

`> admin > Repository > Virtual `

- advanced: port -> 12345

### nginx配置

```
###########################################################
## this configuration was generated by JFrog Artifactory ##
###########################################################

## server configuration
server {
    
    listen 80 ;
    
    server_name myartifactory;
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/myartifactory-access.log timing;
    ## error_log /var/log/nginx/myartifactory-error.log;
    rewrite ^/$ /artifactory/webapp/ redirect;
    rewrite ^/artifactory/?(/webapp)?$ /artifactory/webapp/ redirect;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location /artifactory/ {
    proxy_read_timeout  2400s;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    if ( $request_uri ~ ^/artifactory/(.*)$ ) {
        proxy_pass          http://localhost:8081/artifactory/$1;
    }
    proxy_pass          http://localhost:8081/artifactory/;
    proxy_set_header    X-Artifactory-Override-Base-Url $http_x_forwarded_proto://$host:$server_port/artifactory;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    }
}


## server configuration
server {
    listen 12345;
    
    
    server_name myartifactory;
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/myartifactory-access.log timing;
    ## error_log /var/log/nginx/myartifactory-error.log;
    rewrite ^/(v1|v2)/(.*) /artifactory/api/docker/v-docker/$1/$2;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location /artifactory/ {
    proxy_read_timeout  2400s;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    proxy_pass          http://localhost:8081/artifactory/;
    proxy_set_header    X-Artifactory-Override-Base-Url $http_x_forwarded_proto://$host:$server_port/artifactory;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    }
}
```

### docker client配置

```json
{
    "insecure-registries" : [ "myartifactory:12345" ],
    "registry-mirrors" : ["http://myartifactory:12345"]
}
```

### docker client命令

```
docker login myartifactory:12345
docker pull myartifactory:12345/library/hello-world
docker push myartifactory:12345/library/hello-world2
```





